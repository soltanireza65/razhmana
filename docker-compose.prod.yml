services:
  caddy:
    image: caddy:latest
    restart: unless-stopped
    container_name: caddy
    env_file:
      - .env
    ports:
      - ${CADDY_PORT_HTTP}:80
      - ${CADDY_PORT_HTTPS}:443
    networks:
      - caddy
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile
      - ./site:/srv
      - caddy_data:/data
      - caddy_config:/config
  
  db:
    image: mysql
    # NOTE: use of "mysql_native_password" is not recommended: https://dev.mysql.com/doc/refman/8.0/en/upgrading-from-previous-series.html#upgrade-caching-sha2-password
    # (this is just an example, not intended to be a production configuration)
    command: --default-authentication-plugin=mysql_native_password
    restart: always
    env_file:
      - .env
    ports:
      - ${MYSQL_PORT}:3306
    networks:
      - caddy
    volumes:
      - mysql_data:/var/lib/mysql
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: ${MYSQL_DATABASE}
      MYSQL_USER: ${MYSQL_USER}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
  
  web:
    image: soltanireza65/razhmana-web:latest
    restart: always
    env_file:
      - .env
    ports:
      - "${WEB_PORT}:80"
    networks:
      - caddy

  php:
    image: soltanireza65/razhmana-php:latest
    restart: always
    networks:
      - caddy

volumes:
  mysql_data:
  caddy_data:
  caddy_config:

networks:
  caddy:
